
version: '3'

services:
  stablediff-gpu:
    build:
      context: .
      dockerfile: Dockerfile.gpu
    container_name: stablediff-gpu-runner
    environment:
      TZ: "America/New_York"
      COMMANDLINE_ARGS: "--listen --lowvram"
    entrypoint: ["/bin/sh", "-c"]
    command: >
      ". /stablediff.env; echo launch.py $$COMMANDLINE_ARGS;
      if [ ! -d /stablediff-web/.git ]; then
        cp -a /sdtemp/. /stablediff-web/
      fi;
      if [ ! -f /stablediff-web/models/Stable-diffusion/*.ckpt ]; then
        echo 'Please copy stable diffusion model to stablediff-models directory'
        echo 'You may need sudo to perform this action'
        exit 1
      fi;
      python launch.py"
    ports:
      - "7860:7860"
    volumes:
      - /home/stable-diffusion/models:/stablediff-web/models/Stable-diffusion
      - /home/stable-diffusion/web:/stablediff-web
      - /home/stable-diffusion/stablediff.env:/stablediff.env
